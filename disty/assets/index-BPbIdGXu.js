var _t=Object.defineProperty;var ut=e=>{throw TypeError(e)};var Ft=(e,t,n)=>t in e?_t(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var p=(e,t,n)=>Ft(e,typeof t!="symbol"?t+"":t,n),mt=(e,t,n)=>t.has(e)||ut("Cannot "+n);var i=(e,t,n)=>(mt(e,t,"read from private field"),n?n.call(e):t.get(e)),I=(e,t,n)=>t.has(e)?ut("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),z=(e,t,n,r)=>(mt(e,t,"write to private field"),r?r.call(e,n):t.set(e,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();const Ut="modulepreload",Nt=function(e){return"/Parallaxer/"+e},ht={},Et=function(t,n,r){let a=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),c=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));a=Promise.allSettled(n.map(f=>{if(f=Nt(f),f in ht)return;ht[f]=!0;const w=f.endsWith(".css"),L=w?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${L}`))return;const d=document.createElement("link");if(d.rel=w?"stylesheet":Ut,w||(d.as="script"),d.crossOrigin="",d.href=f,c&&d.setAttribute("nonce",c),document.head.appendChild(d),w)return new Promise((E,D)=>{d.addEventListener("load",E),d.addEventListener("error",()=>D(new Error(`Unable to preload CSS for ${f}`)))})}))}function o(s){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=s,window.dispatchEvent(c),!c.defaultPrevented)throw s}return a.then(s=>{for(const c of s||[])c.status==="rejected"&&o(c.reason);return t().catch(o)})};var l;(function(e){e.LOAD="LOAD",e.EXEC="EXEC",e.FFPROBE="FFPROBE",e.WRITE_FILE="WRITE_FILE",e.READ_FILE="READ_FILE",e.DELETE_FILE="DELETE_FILE",e.RENAME="RENAME",e.CREATE_DIR="CREATE_DIR",e.LIST_DIR="LIST_DIR",e.DELETE_DIR="DELETE_DIR",e.ERROR="ERROR",e.DOWNLOAD="DOWNLOAD",e.PROGRESS="PROGRESS",e.LOG="LOG",e.MOUNT="MOUNT",e.UNMOUNT="UNMOUNT"})(l||(l={}));const Pt=(()=>{let e=0;return()=>e++})(),Bt=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),Ct=new Error("called FFmpeg.terminate()");var b,$,v,F,U,et,g;class Mt{constructor(){I(this,b,null);I(this,$,{});I(this,v,{});I(this,F,[]);I(this,U,[]);p(this,"loaded",!1);I(this,et,()=>{i(this,b)&&(i(this,b).onmessage=({data:{id:t,type:n,data:r}})=>{switch(n){case l.LOAD:this.loaded=!0,i(this,$)[t](r);break;case l.MOUNT:case l.UNMOUNT:case l.EXEC:case l.FFPROBE:case l.WRITE_FILE:case l.READ_FILE:case l.DELETE_FILE:case l.RENAME:case l.CREATE_DIR:case l.LIST_DIR:case l.DELETE_DIR:i(this,$)[t](r);break;case l.LOG:i(this,F).forEach(a=>a(r));break;case l.PROGRESS:i(this,U).forEach(a=>a(r));break;case l.ERROR:i(this,v)[t](r);break}delete i(this,$)[t],delete i(this,v)[t]})});I(this,g,({type:t,data:n},r=[],a)=>i(this,b)?new Promise((o,s)=>{const c=Pt();i(this,b)&&i(this,b).postMessage({id:c,type:t,data:n},r),i(this,$)[c]=o,i(this,v)[c]=s,a==null||a.addEventListener("abort",()=>{s(new DOMException(`Message # ${c} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(Bt));p(this,"load",({classWorkerURL:t,...n}={},{signal:r}={})=>(i(this,b)||(z(this,b,t?new Worker(new URL(t,import.meta.url),{type:"module"}):new Worker(new URL("/Parallaxer/assets/worker-BAOIWoxA.js",import.meta.url),{type:"module"})),i(this,et).call(this)),i(this,g).call(this,{type:l.LOAD,data:n},void 0,r)));p(this,"exec",(t,n=-1,{signal:r}={})=>i(this,g).call(this,{type:l.EXEC,data:{args:t,timeout:n}},void 0,r));p(this,"ffprobe",(t,n=-1,{signal:r}={})=>i(this,g).call(this,{type:l.FFPROBE,data:{args:t,timeout:n}},void 0,r));p(this,"terminate",()=>{const t=Object.keys(i(this,v));for(const n of t)i(this,v)[n](Ct),delete i(this,v)[n],delete i(this,$)[n];i(this,b)&&(i(this,b).terminate(),z(this,b,null),this.loaded=!1)});p(this,"writeFile",(t,n,{signal:r}={})=>{const a=[];return n instanceof Uint8Array&&a.push(n.buffer),i(this,g).call(this,{type:l.WRITE_FILE,data:{path:t,data:n}},a,r)});p(this,"mount",(t,n,r)=>{const a=[];return i(this,g).call(this,{type:l.MOUNT,data:{fsType:t,options:n,mountPoint:r}},a)});p(this,"unmount",t=>{const n=[];return i(this,g).call(this,{type:l.UNMOUNT,data:{mountPoint:t}},n)});p(this,"readFile",(t,n="binary",{signal:r}={})=>i(this,g).call(this,{type:l.READ_FILE,data:{path:t,encoding:n}},void 0,r));p(this,"deleteFile",(t,{signal:n}={})=>i(this,g).call(this,{type:l.DELETE_FILE,data:{path:t}},void 0,n));p(this,"rename",(t,n,{signal:r}={})=>i(this,g).call(this,{type:l.RENAME,data:{oldPath:t,newPath:n}},void 0,r));p(this,"createDir",(t,{signal:n}={})=>i(this,g).call(this,{type:l.CREATE_DIR,data:{path:t}},void 0,n));p(this,"listDir",(t,{signal:n}={})=>i(this,g).call(this,{type:l.LIST_DIR,data:{path:t}},void 0,n));p(this,"deleteDir",(t,{signal:n}={})=>i(this,g).call(this,{type:l.DELETE_DIR,data:{path:t}},void 0,n))}on(t,n){t==="log"?i(this,F).push(n):t==="progress"&&i(this,U).push(n)}off(t,n){t==="log"?z(this,F,i(this,F).filter(r=>r!==n)):t==="progress"&&z(this,U,i(this,U).filter(r=>r!==n))}}b=new WeakMap,$=new WeakMap,v=new WeakMap,F=new WeakMap,U=new WeakMap,et=new WeakMap,g=new WeakMap;var pt;(function(e){e.MEMFS="MEMFS",e.NODEFS="NODEFS",e.NODERAWFS="NODERAWFS",e.IDBFS="IDBFS",e.WORKERFS="WORKERFS",e.PROXYFS="PROXYFS"})(pt||(pt={}));const Tt=e=>new Promise((t,n)=>{const r=new FileReader;r.onload=()=>{const{result:a}=r;a instanceof ArrayBuffer?t(new Uint8Array(a)):t(new Uint8Array)},r.onerror=a=>{var o,s;n(Error(`File could not be read! Code=${((s=(o=a==null?void 0:a.target)==null?void 0:o.error)==null?void 0:s.code)||-1}`))},r.readAsArrayBuffer(e)}),kt=async e=>{let t;if(typeof e=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(e)?t=atob(e.split(",")[1]).split("").map(n=>n.charCodeAt(0)):t=await(await fetch(e)).arrayBuffer();else if(e instanceof URL)t=await(await fetch(e)).arrayBuffer();else if(e instanceof File||e instanceof Blob)t=await Tt(e);else return new Uint8Array;return new Uint8Array(t)},h=e=>document.getElementById(e),C=h("file"),Wt=h("fileLabel"),q=h("loadBtn"),M=h("runBtn"),nt=h("fps"),Rt=h("maxW"),yt=h("strength"),rt=h("maxFrames"),Lt=h("crf"),bt=h("preset"),xt=h("includeAudio"),J=h("fileMeta"),jt=h("bar"),zt=h("status"),Y=h("log"),H=h("download"),Q=h("preview"),Dt="/Parallaxer/",ct=new URL(Dt,window.location.origin),Xt=400,X=[];function y(e){X.push(e),X.length>Xt&&X.shift(),Y.textContent=X.join(`
`),Y.scrollTop=Y.scrollHeight}function Gt(){X.length=0,Y.textContent=""}function x(e){zt.textContent=e}function B(e){const t=Math.max(0,Math.min(1,e));jt.style.width=`${Math.round(t*100)}%`}function S(e,t,n){return Math.max(t,Math.min(n,e))}async function gt(e){return new Uint8Array(await e.arrayBuffer())}function Ot(){H.style.display="none",H.removeAttribute("href"),Q.style.display="none",Q.removeAttribute("src")}function V(e){[C,nt,Rt,yt,rt,Lt,bt,xt].forEach(t=>{t&&(t.disabled=e)})}const m=new Mt;let tt=!1;async function qt(){tt||(await m.load({coreURL:new URL("ffmpeg/ffmpeg-core.js",ct).toString(),wasmURL:new URL("ffmpeg/ffmpeg-core.wasm",ct).toString(),workerURL:new URL("ffmpeg/ffmpeg-core.worker.js",ct).toString()}),m.on("log",({message:e})=>y(`[ffmpeg] ${e}`)),m.on("progress",({progress:e})=>B(e)),tt=!0,y("FFmpeg loaded."))}let Z=null,A=null,G="wasm",K=null;const lt=new Intl.NumberFormat;function Ht(e){if(!Number.isFinite(e))return"Unknown duration";const t=Math.max(0,Math.floor(e)),n=Math.floor(t/3600),r=Math.floor(t%3600/60),a=t%60;return n>0?`${n}:${String(r).padStart(2,"0")}:${String(a).padStart(2,"0")}`:`${r}:${String(a).padStart(2,"0")}`}function Vt(e){return Number.isFinite(e)?`${(e/(1024*1024)).toFixed(1)} MB`:"Unknown size"}function dt(){if(!K){J.textContent="No file selected.";return}const e=S(parseInt(nt.value,10)||8,1,30),t=S(parseInt(rt.value,10)||120,1,9999),{duration:n,width:r,height:a,size:o}=K,s=Number.isFinite(n)?Math.ceil(n*e):null,c=[`Duration: ${Ht(n)}`,`Resolution: ${r&&a?`${r}×${a}`:"Unknown resolution"}`,`File size: ${Vt(o)}`];s&&(c.push(`Estimated frames @ ${e} fps: ${lt.format(s)}`),s>t&&c.push(`Will process ${lt.format(t)} of ${lt.format(s)} frames.`)),J.textContent=c.join(`
`)}async function Kt(e){return new Promise((t,n)=>{const r=document.createElement("video");r.preload="metadata";const a=URL.createObjectURL(e),o=()=>{URL.revokeObjectURL(a),r.removeAttribute("src"),r.load()};r.onloadedmetadata=()=>{const s={duration:r.duration,width:r.videoWidth,height:r.videoHeight,size:e.size};o(),t(s)},r.onerror=()=>{o(),n(new Error("Unable to read metadata"))},r.src=a})}async function Yt(){try{Z=await Et(()=>import("./ort.webgpu.bundle.min-BTTGg_UR.js"),[]),G="webgpu"}catch{try{Z=await Et(()=>import("./ort.bundle.min-DCl7Qykv.js"),[]),G="wasm"}catch(t){throw new Error(`Failed to load ONNX Runtime. ${(t==null?void 0:t.message)||t}`)}}const e=`${Dt}models/model-small.onnx`;A=await Z.InferenceSession.create(e,{executionProviders:G==="webgpu"?["webgpu","wasm"]:["wasm"],graphOptimizationLevel:"all"}),y(`ONNX Runtime loaded (${G}).`),y(`Model inputs: ${A.inputNames.join(", ")}`),y(`Model outputs: ${A.outputNames.join(", ")}`)}const R=256,O=256;function Zt(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height,t.getContext("2d",{willReadFrequently:!0}).putImageData(e,0,0);const r=document.createElement("canvas");r.width=R,r.height=O;const a=r.getContext("2d",{willReadFrequently:!0});a.drawImage(t,0,0,R,O);const{data:o}=a.getImageData(0,0,R,O),s=[.485,.456,.406],c=[.229,.224,.225],f=new Float32Array(1*3*R*O),w=R*O;for(let L=0;L<O;L++)for(let d=0;d<R;d++){const E=(L*R+d)*4,D=o[E]/255,at=o[E+1]/255,T=o[E+2]/255,_=L*R+d;f[_]=(D-s[0])/c[0],f[w+_]=(at-s[1])/c[1],f[2*w+_]=(T-s[2])/c[2]}return new Z.Tensor("float32",f,[1,3,O,R])}function Jt(e){let t=1/0,n=-1/0;for(let o=0;o<e.length;o++){const s=e[o];s<t&&(t=s),s>n&&(n=s)}const r=n-t||1,a=new Float32Array(e.length);for(let o=0;o<e.length;o++)a[o]=(e[o]-t)/r;return a}function Qt(e,t,n){const r=new Float32Array(e.length);for(let a=0;a<n;a++)for(let o=0;o<t;o++){let s=0,c=0;for(let f=-1;f<=1;f++)for(let w=-1;w<=1;w++){const L=o+w,d=a+f;L>=0&&L<t&&d>=0&&d<n&&(s+=e[d*t+L],c++)}r[a*t+o]=s/c}return r}function te(e,t,n){const r=e.width,a=e.height,o=e.data,s=new ImageData(r,a),c=s.data;for(let f=0;f<a;f++){const w=f/(a-1),L=Math.floor(w*(O-1));for(let d=0;d<r;d++){const E=d/(r-1),D=Math.floor(E*(R-1)),T=(1-t[L*R+D])*n,_=Math.round(S(d+T,0,r-1)),N=(f*r+_)*4,u=(f*r+d)*4;c[u]=o[N],c[u+1]=o[N+1],c[u+2]=o[N+2],c[u+3]=255}}return s}async function wt(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height,t.getContext("2d",{willReadFrequently:!0}).putImageData(e,0,0);const r=await new Promise(s=>t.toBlob(s,"image/png"));if(r)return gt(r);const a=t.toDataURL("image/png"),o=await fetch(a).then(s=>s.blob());return gt(o)}async function ee(e){Ot();const t=S(parseInt(nt.value,10)||8,1,30),n=S(parseInt(Rt.value,10)||512,240,1920),r=S(parseInt(yt.value,10)||12,1,40),a=S(parseInt(rt.value,10)||120,1,9999),o=S(parseInt(Lt.value,10)||18,12,30),s=bt.value||"veryfast",c=xt.checked;B(0),x("Writing input…"),y(`Parallaxer settings: fps=${t}, maxW=${n}, strength=${r}px, maxFrames=${a}, crf=${o}, preset=${s}, audio=${c?"on":"off"}`);try{await m.deleteFile("/input.mp4")}catch{}for(const u of["/frames","/L","/R"])try{const k=await m.listDir(u);for(const W of k)if(W.name!=="."&&W.name!=="..")try{await m.deleteFile(`${u}/${W.name}`)}catch{}try{await m.deleteDir(u)}catch{}}catch{}await m.createDir("/frames"),await m.createDir("/L"),await m.createDir("/R"),await m.writeFile("/input.mp4",await kt(e)),x("Extracting frames…"),B(.02);const f=`fps=${t},scale=${n}:-2`;if(await m.exec(["-i","/input.mp4","-vf",f,"-vcodec","png","/frames/%05d.png"])!==0)throw new Error("FFmpeg frame extraction failed.");const d=(await m.listDir("/frames")).filter(u=>u.name.endsWith(".png")).map(u=>u.name).sort(),E=d.slice(0,a);y(`Frames extracted: ${d.length}. Processing: ${E.length}.`),E.length<d.length&&y(`Frame limit reached. Skipping ${d.length-E.length} frames.`),x("Depth + right-eye synthesis…");for(let u=0;u<E.length;u++){const k=E[u],W=await m.readFile(`/frames/${k}`),vt=new Blob([W],{type:"image/png"}),ot=await createImageBitmap(vt),j=document.createElement("canvas");j.width=ot.width,j.height=ot.height;const ft=j.getContext("2d",{willReadFrequently:!0});ft.drawImage(ot,0,0);const st=ft.getImageData(0,0,j.width,j.height),It=Zt(st),St={[A.inputNames[0]]:It};let P=(await A.run(St))[A.outputNames[0]].data;if(P instanceof Float32Array||(P=Float32Array.from(P)),P.length!==R*O)throw new Error(`Unexpected depth size: ${P.length}. Expected ${R*O}.`);let it=Jt(P);it=Qt(it,R,O);const $t=te(st,it,r);await m.writeFile(`/L/${k}`,await wt(st)),await m.writeFile(`/R/${k}`,await wt($t));const At=.1+.7*((u+1)/E.length);B(At),x(`Frame ${u+1}/${E.length}`)}x("Encoding SBS video…"),B(.82);const D=["-framerate",String(t),"-i","/L/%05d.png","-framerate",String(t),"-i","/R/%05d.png"];if(c&&D.push("-i","/input.mp4"),D.push("-filter_complex","[0:v][1:v]hstack=inputs=2[v]","-map","[v]"),c&&D.push("-map","2:a?","-c:a","aac","-b:a","192k","-shortest"),D.push("-c:v","libx264","-pix_fmt","yuv420p","-crf",String(o),"-preset",s,"-movflags","+faststart","/Parallaxer_SBS.mp4"),await m.exec(D)!==0)throw new Error("FFmpeg encode failed.");const T=await m.readFile("/Parallaxer_SBS.mp4"),_=new Blob([T],{type:"video/mp4"}),N=URL.createObjectURL(_);H.href=N,H.download="Parallaxer_SBS.mp4",H.style.display="inline-flex",Q.src=N,Q.style.display="block",B(1),x("Complete."),y("Done.")}C.addEventListener("change",async()=>{var t;const e=(t=C.files)==null?void 0:t[0];if(Ot(),!!e){if(!e.type.startsWith("video/")){x("Please choose a valid video file."),C.value="",K=null,dt();return}Wt.textContent=`${e.name} (${Math.round(e.size/(1024*1024))} MB)`,M.disabled=!tt||!A,J.textContent="Reading metadata…";try{K=await Kt(e)}catch{K=null,J.textContent="Unable to read metadata for this file.";return}dt()}});[nt,rt].forEach(e=>{e.addEventListener("input",()=>{dt()})});q.addEventListener("click",async()=>{var e;try{q.disabled=!0,M.disabled=!0,V(!0),x("Loading engines…"),Gt(),y("Loading FFmpeg core…"),await qt(),y("Loading ONNX Runtime + MiDaS…"),await Yt(),x("Engines loaded. Choose a file and generate."),V(!1),M.disabled=!((e=C.files)!=null&&e[0])}catch(t){x(`Error: ${t.message||t}`),q.disabled=!1,V(!1)}});M.addEventListener("click",async()=>{var t;const e=(t=C.files)==null?void 0:t[0];if(e){if(!tt||!A){x('Engines not loaded yet. Click "Load Engines" first.');return}if(!e.type.startsWith("video/")){x("Please choose a valid video file.");return}try{M.disabled=!0,q.disabled=!0,V(!0),y("---"),y(`Starting Parallaxer… (ORT backend: ${G})`),await ee(e)}catch(n){x(`Error: ${n.message||n}`),y(`[error] ${n.stack||n}`)}finally{M.disabled=!1,q.disabled=!1,V(!1)}}});
